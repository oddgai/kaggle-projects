# exp004 - 高度な特徴量エンジニアリングによる性能向上

## 概要

exp001-003の結果を踏まえ、名前、チケット、客室等から高度な特徴量を抽出してモデル性能の大幅な向上を達成した実験。

## ベースとなる実験

exp001（LightGBMベースライン、16特徴量）

## 実験設定

### 使用モデル

LightGBM（回帰モード + 閾値0.5での二値分類）

### 特徴量エンジニアリング戦略

#### 1. 名前からの高度特徴量抽出
- **敬称の詳細グループ化**: Mr, Mrs, Miss, Master, Rare, Otherへの分類
- **家族グループサイズ**: 同一苗字を持つ乗客数（train+testの全データから算出）
- **名前の長さ**: 社会的地位の指標として活用

#### 2. チケット情報の活用
- **グループチケット人数**: 同一チケット番号を持つ乗客数
- **チケット形式判定**: 数字のみ vs 英字混在の判定
- **チケットプレフィックス**: 英字部分の分類（販売代理店や路線の識別）

#### 3. 客室情報の詳細化
- **客室デッキ**: A-G, Unknown等のデッキレベル分類
- **客室番号**: 数値部分の抽出
- **客室保有数**: 複数客室を持つ場合の数

#### 4. 家族構成の詳細分析
- **家族サイズカテゴリ**: 単身、小家族（2-4人）、大家族（5人以上）
- **詳細な関係性**: IsAlone, IsSmallFamily, IsLargeFamily

#### 5. 統計的特徴量
- **相対順位特徴量**: 
  - 同一性別・クラス内での年齢順位
  - 同一クラス内での運賃順位

#### 6. 交互作用特徴量
- **Age × Fare**: 富裕層の子供等の特殊パターン識別
- **Sex × Pclass**: 既知の強力な交互作用の数値化
- **Age × FamilySize**: 家族構成と年齢の相関

### モデルパラメータ

```python
lgb_params = {
    'objective': 'regression',
    'metric': 'rmse',
    'boosting_type': 'gbdt',
    'num_leaves': 31,
    'learning_rate': 0.1,
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
    'bagging_freq': 5,
    'verbose': -1,
    'random_state': 42
}
```

### 検証方法

5-fold StratifiedKFold交差検証

## 結果

### 性能指標

- **Kaggleスコア**: 0.77990 ← **大幅改善！**
- **CV精度**: 0.8462 ± 0.034
- **OOF精度**: 0.8451

### 特徴量重要度（exp004）

| 順位 | 特徴量 | 重要度 | 分類 |
|------|--------|--------|------|
| 1 | Sex_Pclass | 1439.8 | 既存交互作用 |
| 2 | Sex | 708.2 | 基本特徴量 |
| 3 | Age | 569.3 | 基本特徴量 |
| 4 | Fare | 484.7 | 基本特徴量 |
| 5 | **Title_Grouped** | 415.8 | **新特徴量** |
| 6 | HasCabin | 414.4 | 既存特徴量 |
| 7 | Pclass | 408.1 | 基本特徴量 |
| 8 | **Surname_Count** | 307.9 | **新特徴量** |
| 9 | **Age_Fare_Interaction** | 303.8 | **新特徴量** |
| 10 | Embarked | 276.9 | 基本特徴量 |

## 分析

### 実験結果の考察

1. **大幅な性能向上を達成**
   - Kaggleスコア: 0.77272 → **0.77990** (+0.00718, +0.93%)
   - これまでで最高の成果を記録

2. **新特徴量の効果が顕著**
   - **Title_Grouped**: 重要度5位（415.8）
   - **Surname_Count**: 重要度8位（307.9）
   - **Age_Fare_Interaction**: 重要度9位（303.8）
   
3. **CV vs Kaggle精度の関係**
   - CV: 0.8462（exp002と同等）
   - Kaggle: 0.77990（大幅改善）
   - CV精度では測れない汎化性能の向上を実現

4. **特徴量エンジニアリングの成功要因**
   - **名前情報の活用**: 敬称と家族グループが予想以上に効果的
   - **全データ活用**: train+testでの統計計算が精度向上に寄与
   - **交互作用の発見**: Age×Fareの組み合わせが新たなパターンを捉えた

### 新特徴量の詳細効果分析

#### 効果的だった特徴量
1. **Title_Grouped（重要度: 415.8）**
   - Mr, Mrs, Miss, Master, Rareの分類が生存予測に大きく貢献
   - 社会的地位と性別・年齢の複合情報を効率的に表現

2. **Surname_Count（重要度: 307.9）**
   - 家族・親戚グループのサイズが予測に重要
   - 大家族ほど生存率が異なるパターンを捉えた

3. **Age_Fare_Interaction（重要度: 303.8）**
   - 年齢と運賃の組み合わせが新たな生存パターンを発見
   - 富裕層の子供、一般層の高齢者等の細かい分類に貢献

#### その他の効果的な特徴量
- **Ticket_Count**: グループ旅行者の識別
- **Cabin_Deck**: 船内位置による脱出の難易度差
- **統計順位特徴量**: 相対的位置による細分化

### 次の実験に向けた改善案

1. **さらなる交互作用の探索**
   - Title × Pclass の組み合わせ
   - Cabin_Deck × Age の相関分析
   - Ticket_Prefix × Fare の関係性

2. **時系列・順序特徴量の追加**
   - PassengerIdを乗船順序として活用
   - 客室番号の連続性による近隣乗客との関係性

3. **アンサンブル手法の導入**
   - 異なるアルゴリズム（XGBoost, CatBoost）との組み合わせ
   - Stacking・Blendingによるさらなる性能向上

4. **外部データの活用**
   - 歴史的事実（脱出順序、船内配置）の特徴量化

## 結論

exp004では高度な特徴量エンジニアリングにより、**Kaggleスコア0.77990を達成し、ベースラインから0.93%の大幅改善を実現**した。

### 成功要因
1. **名前からの社会的情報抽出**（敬称、家族グループサイズ）
2. **チケット・客室情報の活用**（グループ識別、位置情報）
3. **統計的相対位置特徴量**（順位情報）
4. **効果的な交互作用の発見**（Age×Fare）

### 学習した知見
- CV精度だけでは測れない汎化性能の向上
- 全データ（train+test）を使った統計量計算の重要性
- ドメイン知識を活用した特徴量設計の効果

この結果により、特徴量エンジニアリングの方向性が正しいことが実証され、さらなる改善の可能性が示された。